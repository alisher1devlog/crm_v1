// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum StaffRole {
  SUPER_ADMIN
  ADMIN
  USER
  TEACHER
}

enum StaffStatus {
  ACTIVE
  INACTIVE
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum GroupStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

enum StudentGroupStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

enum AttendanceStatus  {
  PRESENT
  ABSENT
  LATE
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model Staff {
  id        Int         @id @default(autoincrement())
  firstName String      @map("first_name") @db.VarChar(100)
  lastName  String      @map("last_name") @db.VarChar(100)
  username  String      @unique @db.VarChar(50)
  password  String      @db.VarChar(255)
  role      StaffRole
  position  String      @db.VarChar(100)
  phone     String?     @db.VarChar(20)
  address   String?     @db.Text
  hireDate  DateTime    @default(now()) @map("hire_date") @db.Date
  status    StaffStatus @default(ACTIVE)
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  groupsTeaching Group[]
  lessonsCreated Lesson[]
  attendances    Attendance[]
  payments       Payment[]

  @@map("staffs")
}

model Student {
  id             Int           @id @default(autoincrement())
  firstName      String        @map("first_name") @db.VarChar(100)
  lastName       String        @map("last_name") @db.VarChar(100)
  username       String?       @unique @db.VarChar(50)
  password       String?       @db.VarChar(255)
  phone          String?       @db.VarChar(20)
  address        String?       @db.Text
  birthDate      DateTime?     @map("birth_date") @db.Date
  status         StudentStatus @default(ACTIVE)
  enrollmentDate DateTime      @default(now()) @map("enrollment_date") @db.Date
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  studentGroups     StudentGroup[]
  attendanceDetails AttendanceDetail[]
  payments          Payment[]

  @@map("students")
}

model Course {
  id          Int          @id @default(autoincrement())
  name        String       @db.VarChar(100)
  description String?      @db.Text
  price       Int
  duration    Int // Duration in months
  level       CourseLevel?
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  groups Group[]

  @@map("courses")
}

model Group {
  id          Int         @id @default(autoincrement())
  name        String      @db.VarChar(50)
  courseId    Int         @map("course_id")
  teacherId   Int         @map("teacher_id")
  startDate   DateTime    @map("start_date") @db.Date
  endDate     DateTime?   @map("end_date") @db.Date
  schedule    String?     @db.Text
  maxStudents Int         @default(20) @map("max_students")
  status      GroupStatus @default(PLANNED)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  course        Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher       Staff          @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  studentGroups StudentGroup[]
  lessons       Lesson[]
  schedules     Schedule[]
  payments      Payment[]

  @@index([courseId])
  @@index([teacherId])
  @@map("groups")
}

model StudentGroup {
  id        Int                @id @default(autoincrement())
  studentId Int                @map("student_id")
  groupId   Int                @map("group_id")
  joinDate  DateTime           @default(now()) @map("join_date") @db.Date
  status    StudentGroupStatus @default(ACTIVE)
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId])
  @@index([studentId])
  @@index([groupId])
  @@map("student_groups")
}

model Lesson {
  id          Int      @id @default(autoincrement())
  groupId     Int      @map("group_id")
  title       String?  @db.VarChar(255)
  description String?  @db.Text
  lessonDate  DateTime @map("lesson_date") @db.Date
  startTime   DateTime @map("start_time") @db.Time(0)
  endTime     DateTime @map("end_time") @db.Time(0)
  roomNumber  String?  @map("room_number") @db.VarChar(20)
  createdBy   Int      @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  group       Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  creator     Staff        @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  attendances Attendance[]

  @@index([groupId])
  @@index([lessonDate])
  @@map("lessons")
}

model Attendance {
  id        Int      @id @default(autoincrement())
  lessonId  Int      @map("lesson_id")
  createdBy Int      @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  lesson  Lesson             @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  creator Staff              @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  details AttendanceDetail[]

  @@unique([lessonId])
  @@map("attendance")
}

model AttendanceDetail {
  id           Int              @id @default(autoincrement())
  attendanceId Int              @map("attendance_id")
  studentId    Int              @map("student_id")
  status       AttendanceStatus
  comment      String?          @db.Text

  // Relations
  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([attendanceId, studentId])
  @@index([attendanceId])
  @@index([studentId])
  @@map("attendance_details")
}

model Payment {
  id            Int           @id @default(autoincrement())
  studentId     Int           @map("student_id")
  groupId       Int           @map("group_id")
  amount        Int
  paymentDate   DateTime      @default(now()) @map("payment_date") @db.Date
  paymentMethod PaymentMethod @map("payment_method")
  description   String?       @db.Text
  receiptNumber String?       @map("receipt_number") @db.VarChar(50)
  createdBy     Int           @map("created_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  creator Staff   @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([groupId])
  @@index([paymentDate])
  @@map("payments")
}

model Schedule {
  id         Int       @id @default(autoincrement())
  groupId    Int       @map("group_id")
  day        DayOfWeek
  startTime  DateTime  @map("start_time") @db.Time(0)
  endTime    DateTime  @map("end_time") @db.Time(0)
  roomNumber String?   @map("room_number") @db.VarChar(20)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, day, startTime])
  @@index([groupId])
  @@map("schedule")
}